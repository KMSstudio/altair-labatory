// prisma/schema.prisma

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

// =========================
// ENUMS
// =========================

enum UserRole {
  USER
  PI
  ADMIN

  @@map("user_role")
}

enum PIApplicationStatus {
  PENDING
  APPROVED
  REJECTED

  @@map("pi_application_status")
}

enum Visibility {
  PUBLIC
  PRIVATE
  PROTECT

  @@map("visibility")
}

// =========================
// USERS / CREDENTIALS
// =========================

model User {
  id           BigInt   @id @default(autoincrement())
  displayName  String   @db.VarChar(100) @map("display_name")
  role         UserRole @default(USER)
  primaryEmail String?  @db.VarChar(255) @map("primary_email")

  pi           PI?

  credentials UserCredential[]
  piApplications PIApplication[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  reviews        LabReview[]
  reviewReports  LabReviewReport[]

  @@map("users")
}

model UserCredential {
  id             BigInt  @id @default(autoincrement())
  userId         BigInt  @map("user_id")
  provider       String  @db.VarChar(50)
  providerUserId String  @db.VarChar(255) @map("provider_user_id")
  email          String? @db.VarChar(255)
  emailVerified  Boolean @default(false) @map("email_verified")
  isPrimary      Boolean @default(false) @map("is_primary")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([provider, providerUserId], map: "user_credentials_provider_provider_user_id_key")
  @@index([userId], map: "idx_user_credentials_user_id")
  @@index([email],  map: "idx_user_credentials_email")
  @@map("user_credentials")
}

// =========================
// UNIVERSITIES
// =========================

model University {
  id         BigInt  @id @default(autoincrement())
  nameKo     String  @db.VarChar(200) @map("name_ko")
  nameEn     String? @db.VarChar(200) @map("name_en")
  country    String? @db.VarChar(100)
  websiteUrl String? @db.VarChar(1024) @map("website_url")

  labs Lab[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([nameKo], map: "universities_name_ko_key")
  @@index([country], map: "idx_universities_country")
  @@map("universities")
}

// =========================
// PI / PI APPLICATIONS / PI EMAILS
// =========================

model PI {
  id             BigInt   @id @default(autoincrement())
  name           String   @db.VarChar(100)
  email          String   @db.VarChar(100)
  scholarUrl     String   @db.Text @map("scholar_url")

  userId BigInt? @unique @map("user_id")
  labId  BigInt? @unique @map("lab_id")

  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  lab    Lab?    @relation(fields: [labId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([name],   map: "idx_pi_name")
  @@map("pi")
}

model PIApplication {
  id BigInt @id @default(autoincrement())

  userId BigInt @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  requestedName   String  @db.VarChar(100) @map("requested_name")
  labId           BigInt? @map("lab_id")
  schoolEmail     String  @db.VarChar(255) @map("school_email")
  ScholarUrl      String  @db.Text @map("scholar_url")
  note            String? @db.Text

  status    PIApplicationStatus @default(PENDING)

  decidedBy BigInt? @map("decided_by")
  decidedAt DateTime? @map("decided_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([status, createdAt], map: "idx_pi_applications_status_created")
  @@index([userId],            map: "idx_pi_applications_user")
  @@index([schoolEmail],       map: "idx_pi_applications_school_email")
  @@map("pi_applications")
}

// =========================
// LABS
// =========================

model Lab {
  id BigInt @id @default(autoincrement())

  nameKo      String  @db.VarChar(200) @map("name_ko")
  nameEn      String? @db.VarChar(200) @map("name_en")
  websiteUrl  String? @db.VarChar(1024) @map("website_url")
  description String? @db.Text

  universityId BigInt? @map("university_id")
  university University? @relation(fields: [universityId], references: [id], onDelete: SetNull)
  
  pi      PI?

  subjects LabSubject[]
  reviews  LabReview[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([nameKo],       map: "idx_labs_name_ko")
  @@index([universityId], map: "idx_labs_university")
  @@map("labs")
}

// =========================
// SUBJECTS / LAB_SUBJECTS
// =========================

model Subject {
  id          BigInt  @id @default(autoincrement())
  nameKo      String  @db.VarChar(200) @map("name_ko")
  nameEn      String  @db.VarChar(200) @map("name_en")
  description String? @db.Text
  isActive    Boolean @default(true) @map("is_active")

  labs LabSubject[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([nameKo], map: "subjects_name_ko_key")
  @@unique([nameEn], map: "subjects_name_en_key")
  @@index([isActive], map: "idx_subjects_is_active")
  @@map("subjects")
}

model LabSubject {
  labId     BigInt @map("lab_id")
  subjectId BigInt @map("subject_id")

  lab     Lab     @relation(fields: [labId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@id([labId, subjectId])
  @@index([subjectId, labId], map: "idx_lab_subjects_subject_lab")
  @@map("lab_subjects")
}

// =========================
// LAB REVIEWS / REPORTS
// =========================

model LabReview {
  id BigInt @id @default(autoincrement())

  labId    BigInt @map("lab_id")
  authorId BigInt @map("author_id")

  lab    Lab  @relation(fields: [labId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  content   String  @db.Text
  recommend Boolean @map("recommend")

  atmos     Int @map("atmos")   // 연구실 분위기
  lectr     Int @map("lectr")   // 강의 전달력
  paper     Int @map("paper")   // 논문 지도력
  salry     Int @map("salry")   // 실질 인건비
  persn     Int @map("persn")   // 인품

  visib     Visibility @default(PUBLIC)
  reports   LabReviewReport[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([labId, createdAt],    map: "idx_lab_reviews_lab_created")
  @@index([authorId, createdAt], map: "idx_lab_reviews_author_created")
  @@index([recommend],           map: "idx_lab_reviews_recommend")
  @@map("lab_reviews")
}

model LabReviewReport {
  id BigInt @id @default(autoincrement())

  reviewId   BigInt @map("review_id")
  reporterId BigInt @map("reporter_id")

  review   LabReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reporter User      @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  reason String? @db.VarChar(200)
  detail String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([reviewId, reporterId], map: "lab_review_reports_review_id_reporter_id_key")
  @@index([reviewId, createdAt],    map: "idx_review_reports_review_created")
  @@index([reporterId, createdAt],  map: "idx_review_reports_reporter_created")
  @@map("lab_review_reports")
}
