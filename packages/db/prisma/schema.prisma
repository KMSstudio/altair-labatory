// prisma/schema.prisma

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

// =========================
// ENUMS
// =========================

enum UserRole {
  USER
  PI
  ADMIN

  @@map("user_role")
}

enum PIStatus {
  UNCLAIMED
  PENDING
  VERIFIED

  @@map("pi_status")
}

enum PIApplicationStatus {
  PENDING
  APPROVED
  REJECTED

  @@map("pi_application_status")
}

enum LabReviewVisibility {
  PUBLIC
  PRIVATE

  @@map("lab_review_visibility")
}

// =========================
// USERS / CREDENTIALS
// =========================

model User {
  id           BigInt   @id @default(autoincrement())
  displayName  String   @db.VarChar(100) @map("display_name")
  role         UserRole @default(USER)
  primaryEmail String?  @db.VarChar(255) @map("primary_email")

  piId       BigInt? @unique @map("pi_id")
  piByPiId   PI?     @relation("UserPIByPiId", fields: [piId], references: [id], onDelete: SetNull)

  credentials UserCredential[]
  piApplications PIApplication[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  // Reverse relations (audit)
  createdPIs    PI[]           @relation("PI_CreatedBy")

  createdLabs Lab[] @relation("Lab_CreatedBy")
  updatedLabs Lab[] @relation("Lab_UpdatedBy")

  reviews        LabReview[]
  reviewReports  LabReviewReport[]

  mergedSubjectEvents SubjectMergeEvent[] @relation("SubjectMerge_MergedBy")

  @@map("users")
}

model UserCredential {
  id             BigInt  @id @default(autoincrement())
  userId         BigInt  @map("user_id")
  provider       String  @db.VarChar(50)
  providerUserId String  @db.VarChar(255) @map("provider_user_id")
  email          String? @db.VarChar(255)
  emailVerified  Boolean @default(false) @map("email_verified")
  isPrimary      Boolean @default(false) @map("is_primary")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([provider, providerUserId], map: "user_credentials_provider_provider_user_id_key")
  @@index([userId], map: "idx_user_credentials_user_id")
  @@index([email],  map: "idx_user_credentials_email")
  @@map("user_credentials")
}

// =========================
// UNIVERSITIES
// =========================

model University {
  id         BigInt  @id @default(autoincrement())
  nameKo     String  @db.VarChar(200) @map("name_ko")
  nameEn     String? @db.VarChar(200) @map("name_en")
  country    String? @db.VarChar(100)
  websiteUrl String? @db.VarChar(1024) @map("website_url")

  labs Lab[]
  pis  PI[]

  piApplications PIApplication[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([nameKo], map: "universities_name_ko_key")
  @@index([country], map: "idx_universities_country")
  @@map("universities")
}

// =========================
// PI / PI APPLICATIONS / PI EMAILS
// =========================

model PI {
  id             BigInt   @id @default(autoincrement())
  name           String   @db.VarChar(100)
  univId         BigInt?  @map("univ_id")
  defaultLabId   BigInt?  @map("default_lab_id")
  googleScholarUrl String @db.Text @map("google_scholar_url")
  status         PIStatus @default(UNCLAIMED)

  // Claim-linked user (pi.user_id)
  userId BigInt? @unique @map("user_id")
  usersByPiId User? @relation("UserPIByPiId")

  // Creator (admin or applicant)
  createdBy BigInt? @map("created_by")
  creator   User?   @relation("PI_CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)

  university University? @relation(fields: [univId], references: [id], onDelete: SetNull)

  defaultLab Lab? @relation("PI_DefaultLab", fields: [defaultLabId], references: [id], onDelete: SetNull)

  emails        PIEmail[]
  applications  PIApplication[]
  labs          Lab[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([name],   map: "idx_pi_name")
  @@index([univId], map: "idx_pi_univ")
  @@index([status], map: "idx_pi_status")
  @@map("pi")
}

model PIApplication {
  id BigInt @id @default(autoincrement())

  userId BigInt @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  piId BigInt? @map("pi_id")
  pi   PI?     @relation(fields: [piId], references: [id], onDelete: SetNull)

  requestedName   String  @db.VarChar(100) @map("requested_name")
  univId          BigInt? @map("univ_id")
  labId           BigInt? @map("lab_id")
  schoolEmail     String  @db.VarChar(255) @map("school_email")
  googleScholarUrl String @db.Text @map("google_scholar_url")
  note            String? @db.Text

  status    PIApplicationStatus @default(PENDING)
  decidedBy BigInt? @map("decided_by")
  decidedAt DateTime? @map("decided_at")

  university University? @relation(fields: [univId], references: [id], onDelete: SetNull)
  lab        Lab?        @relation(fields: [labId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([status, createdAt], map: "idx_pi_applications_status_created")
  @@index([userId],            map: "idx_pi_applications_user")
  @@index([piId],              map: "idx_pi_applications_pi")
  @@index([schoolEmail],       map: "idx_pi_applications_school_email")
  @@map("pi_applications")
}

model PIEmail {
  id        BigInt  @id @default(autoincrement())
  piId      BigInt  @map("pi_id")
  email     String  @db.VarChar(255)
  isPrimary Boolean @default(false) @map("is_primary")
  validFrom DateTime? @db.Date @map("valid_from")
  validTo   DateTime? @db.Date @map("valid_to")

  pi PI @relation(fields: [piId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([email],          map: "pi_emails_email_key")
  @@unique([piId, email],    map: "pi_emails_pi_id_email_key")
  @@index([piId],            map: "idx_pi_emails_pi")
  @@map("pi_emails")
}

// =========================
// LABS
// =========================

model Lab {
  id BigInt @id @default(autoincrement())

  nameKo      String  @db.VarChar(200) @map("name_ko")
  nameEn      String? @db.VarChar(200) @map("name_en")
  websiteUrl  String? @db.VarChar(1024) @map("website_url")
  description String? @db.Text

  universityId BigInt? @map("university_id")
  piId         BigInt? @map("pi_id")

  createdBy BigInt? @map("created_by")
  updatedBy BigInt? @map("updated_by")

  university University? @relation(fields: [universityId], references: [id], onDelete: SetNull)
  pi         PI?         @relation(fields: [piId], references: [id], onDelete: SetNull)

  creator User? @relation("Lab_CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updater User? @relation("Lab_UpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)

  subjects LabSubject[]
  reviews  LabReview[]

  defaultForPI PI[] @relation("PI_DefaultLab")
  piApplications PIApplication[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([nameKo],       map: "idx_labs_name_ko")
  @@index([universityId], map: "idx_labs_university")
  @@index([piId],         map: "idx_labs_pi")
  @@map("labs")
}

// =========================
// SUBJECTS / LAB_SUBJECTS
// =========================

model Subject {
  id          BigInt  @id @default(autoincrement())
  nameKo      String  @db.VarChar(200) @map("name_ko")
  nameEn      String? @db.VarChar(200) @map("name_en")
  description String? @db.Text
  isActive    Boolean @default(true) @map("is_active")

  labs LabSubject[]

  mergeEventsFrom SubjectMergeEvent[] @relation("SubjectMerge_From")
  mergeEventsTo   SubjectMergeEvent[] @relation("SubjectMerge_To")

  mergeMapFrom SubjectMergeMap? @relation("SubjectMergeMap_From")
  mergeMapTo   SubjectMergeMap[] @relation("SubjectMergeMap_To")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@unique([nameKo], map: "subjects_name_ko_key")
  @@index([isActive], map: "idx_subjects_is_active")
  @@map("subjects")
}

model LabSubject {
  labId     BigInt @map("lab_id")
  subjectId BigInt @map("subject_id")

  lab     Lab     @relation(fields: [labId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@id([labId, subjectId])
  @@index([subjectId, labId], map: "idx_lab_subjects_subject_lab")
  @@map("lab_subjects")
}

// =========================
// LAB REVIEWS / REPORTS
// =========================

model LabReview {
  id BigInt @id @default(autoincrement())

  labId    BigInt @map("lab_id")
  authorId BigInt @map("author_id")

  title      String? @db.VarChar(200)
  content    String  @db.Text
  rating     Int
  visibility LabReviewVisibility @default(PUBLIC)

  lab    Lab  @relation(fields: [labId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  reports LabReviewReport[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt      @map("updated_at")

  @@index([labId, createdAt],    map: "idx_lab_reviews_lab_created")
  @@index([authorId, createdAt], map: "idx_lab_reviews_author_created")
  @@map("lab_reviews")
}

model LabReviewReport {
  id BigInt @id @default(autoincrement())

  reviewId   BigInt @map("review_id")
  reporterId BigInt @map("reporter_id")

  reason String? @db.VarChar(200)
  detail String? @db.Text

  review   LabReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  reporter User      @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([reviewId, reporterId], map: "lab_review_reports_review_id_reporter_id_key")
  @@index([reviewId, createdAt],    map: "idx_review_reports_review_created")
  @@index([reporterId, createdAt],  map: "idx_review_reports_reporter_created")
  @@map("lab_review_reports")
}

// =========================
// SUBJECT MERGE (EVENT LOG + CANONICAL MAP)
// =========================

model SubjectMergeEvent {
  id BigInt @id @default(autoincrement())

  fromSubjectId BigInt @map("from_subject_id")
  toSubjectId   BigInt @map("to_subject_id")

  mergedBy BigInt? @map("merged_by")
  note     String? @db.Text

  fromSubject Subject @relation("SubjectMerge_From", fields: [fromSubjectId], references: [id], onDelete: Restrict)
  toSubject   Subject @relation("SubjectMerge_To",   fields: [toSubjectId],   references: [id], onDelete: Restrict)

  merger User? @relation("SubjectMerge_MergedBy", fields: [mergedBy], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([toSubjectId, createdAt],   map: "idx_merge_events_to_created")
  @@index([fromSubjectId, createdAt], map: "idx_merge_events_from_created")
  @@map("subject_merge_events")
}

model SubjectMergeMap {
  fromSubjectId BigInt @id @map("from_subject_id")
  toSubjectId   BigInt @map("to_subject_id")

  fromSubject Subject @relation("SubjectMergeMap_From", fields: [fromSubjectId], references: [id], onDelete: Restrict)
  toSubject   Subject @relation("SubjectMergeMap_To",   fields: [toSubjectId],   references: [id], onDelete: Restrict)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([toSubjectId], map: "idx_merge_map_to")
  @@map("subject_merge_map")
}
